{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<body>

    <!-- GoUp START -->
    <button id="topBtn"><i class="fas fa-arrow-up"></i></button>
    <!-- GoUp END -->

   

   
    <!--  Banner START -->

    <div class="banner">
        <div class="banner__overlay">
            <div class="container">
                <div class="row">
                    <div class="col-12 text-center text-lg-start">
                        <h1 class="global__title global__title-dark text-capitalize">single Case</h1>
                        <ul class="banner__ul">
                            <li class="banner__ul-list p-0">
                                <a class="banner__ul-link" href="{% url 'home' %}">
                                    home
                                </a>
                            </li>
                            <li class="banner__ul-list">
                                single Case
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="banner__element d-none d-lg-block">
                    <img src="{% static '/img/element-3.svg' %}" alt="image">
                </div>
                <div class="banner__polygon d-none d-lg-block">
                    <img src="{% static '/img/polygon.svg' %}" alt="image">
                </div>
            </div>
        </div>
    </div>

    <!--  Banner END -->

    <!-- Education START -->
        <div class="education global__py pt-0">
            <div class="container p-sm-0">
                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="col-md-10">
                            <h2 class="global__heading mb-0">{{ case.title }}</h2>
                            <div class="education__card-img">
                                <img class="img-fluid w-100" src="{{ case.image.url }}" alt="{{ case.title }}">
                                <h4 class="education__card-tag">{{ case.category }}</h4>
                            </div>
                            <div class="col-md-7">
                                <div class="cases__card-range">
                                    <p class="global__desc m-0">Founded: {{ case.progress_percentage|floatformat:2 }}%</p>
                                    <div class="progress cases__card-progress">
                                        <div class="progress-bar cases__card-progress--bar" role="progressbar"
                                            style="width: {{ case.progress_percentage }}%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <div class="cases__card-range--bottom">
                                        <div class="d-flex align-items-center cases__card-range--bottom---m gap-2">
                                            <img class="cases__card-range--dollar" src="{% static 'img/box.svg' %}" alt="icon">
                                            <span class="cases__card-range--price">
                                                Raised: ₦{{ case.raised_amount|intcomma }}
                                            </span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <img class="cases__card-range--dollar" src="{% static 'img/dollar-s.svg' %}" alt="icon">
                                            <span class="cases__card-range--price">Goal: ₦{{ case.goal_amount|intcomma }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <div class="card education__card">
                            <!-- <div class="education__card-img">
                                <img class="img-fluid w-100" src="{% static '/img/single-case.png' %}" alt="image">
                                <h4 class="education__card-tag">Education</h4>
                            </div> -->
                            <div class="">
                                <p class="education__para education__para-mt">
                                    {{ case.description }}
                                </p>
                               
                            </div>
                        </div>
                    
                        <div class="col-lg-12 col-xl-10">
                            <form id="donationForm" action="{% url 'case_detail' case.id %}" method="POST" class="form border-0">
                                {% csrf_token %}
                        
                                
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger">
                                        {% for error in form.non_field_errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                        
                                
                                {% if messages %}
                                    {% for message in messages %}
                                        <div class="alert alert-{{ message.tags }}">
                                            {{ message }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                        
                                <!-- Current Amount Display -->
                                <div class="d-flex align-items-center">
                                    <img class="form__icon" src="{% static '/img/dollar-lg-S.svg' %}" alt="icon">
                                    <p class="form__price">₦{{ case.raised_amount|floatformat:2 }}</p>
                                </div>
                                <hr class="form__border">
                        
                                <!-- Donation Amount Options -->
                                <div class="form__mb">
                                    <ul class="form__ul amounts-amounts-grid">
                                        {% for amount in amounts %}
                                            <li class="amount-item">
                                                <label class="form__ul-label form__ul-label--pointer">
                                                    <span class="form__ul-div d-block">
                                                        ₦{{ amount|floatformat:2 |intcomma  }}
                                                        <input type="radio" 
                                                               name="amount" 
                                                               value="{{ amount }}"
                                                               {% if form.amount.value == amount %}checked{% endif %}>
                                                        <span class="form__ul-label--checkmark form__ul-label--checkmark---left"></span>
                                                    </span>
                                                </label>
                                            </li>
                                        {% endfor %}
                        
                                        <!-- Custom Amount Option -->
                                        <li>
                                            <div data-bs-toggle="collapse" 
                                                 data-bs-target="#customAmountCollapse" 
                                                 aria-controls="customAmountCollapse">
                                                <label class="form__ul-label form__ul-label--pointer">
                                                    <span class="form__ul-div d-block">
                                                        Custom Amount
                                                        <input type="radio" 
                                                               name="amount" 
                                                               value=""
                                                               {% if form.custom_amount.value %}checked{% endif %}>
                                                        <span class="form__ul-label--checkmark"></span>
                                                    </span>
                                                </label>
                                            </div>
                                        </li>
                                    </ul>
                        
                                    <!-- Custom Amount Input Field -->
                                    <div class="collapse col-5 col-sm-3 col-lg-2 mt-3" id="customAmountCollapse">
                                        <input class="form-control form__input" 
                                               type="number" 
                                               name="custom_amount" 
                                               placeholder="Enter amount"
                                               min="{{ min_amount }}"
                                               step="50.00"
                                               value="{{ form.custom_amount.value|default:'' }}">
                                        {% if form.custom_amount.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.custom_amount.errors|join:", " }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                        
                                <!-- Donation Type Options -->
                                <div class="form__mb">
                                    <ul class="form__ul">
                                        {% for value, label in form.donation_type.field.choices %}
                                            <li class="bg-transparent py-0 ps-0">
                                                <label class="form__ul-label form__ul-label--pointer">
                                                    <span class="form__ul-div d-block px-0">
                                                        <input type="radio" 
                                                               name="donation_type" 
                                                               value="{{ value }}"
                                                               {% if form.donation_type.value == value %}checked{% endif %}>
                                                        <span class="form__ul-label--checkmark" style="left: 0;"></span>
                                                        {{ label }}
                                                    </span>
                                                </label>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                    {% if form.donation_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.donation_type.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </div>
                        
                                <!-- Personal Information -->
                                <div class="form__mb">
                                    <h4 class="form__heading form__mb">Personal Information</h4>
                                    <div class="d-sm-flex col-12">
                                        <div class="col-sm-6 pe-sm-3">
                                            <label class="form__ul-label form__ul-label--lg" for="{{ form.first_name.id_for_label }}">
                                                First Name<span class="text-danger ps-1">*</span>
                                            </label>
                                            <input class="form-control form__input {% if form.first_name.errors %}is-invalid{% endif %}"
                                                   id="{{ form.first_name.id_for_label }}"
                                                   type="text"
                                                   name="first_name"
                                                   placeholder="First Name"
                                                   value="{{ form.first_name.value|default:'' }}"
                                                   required>
                                            {% if form.first_name.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.first_name.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-sm-6 ps-sm-3 mt-4 mt-sm-0">
                                            <label class="form__ul-label form__ul-label--lg" for="{{ form.last_name.id_for_label }}">
                                                Last Name<span class="text-danger ps-1">*</span>
                                            </label>
                                            <input class="form-control form__input {% if form.last_name.errors %}is-invalid{% endif %}"
                                                   id="{{ form.last_name.id_for_label }}"
                                                   type="text"
                                                   name="last_name"
                                                   placeholder="Last Name"
                                                   value="{{ form.last_name.value|default:'' }}"
                                                   required>
                                            {% if form.last_name.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.last_name.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                        
                                    <div class="col-12 mt-4">
                                        <!-- Email Field -->
                                        <div>
                                            <label class="form__ul-label form__ul-label--lg" for="{{ form.email.id_for_label }}">
                                                Email Address<span class="text-danger ps-1">*</span>
                                            </label>
                                            <input class="form-control form__input {% if form.email.errors %}is-invalid{% endif %}"
                                                   id="{{ form.email.id_for_label }}"
                                                   type="email"
                                                   name="email"
                                                   placeholder="Email"
                                                   value="{{ form.email.value|default:'' }}"
                                                   required>
                                            {% if form.email.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.email.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                        
                                        <!-- Comment Field -->
                                        <div class="mt-4">
                                            <label class="form__ul-label form__ul-label--lg ps-0" for="{{ form.comment.id_for_label }}">
                                                Comment
                                            </label>
                                            <textarea class="form-control form__input {% if form.comment.errors %}is-invalid{% endif %}"
                                                      id="{{ form.comment.id_for_label }}"
                                                      name="comment"
                                                      cols="30"
                                                      rows="5"
                                                      placeholder="Leave a Comment">{{ form.comment.value|default:'' }}</textarea>
                                            {% if form.comment.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.comment.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                        
                                        <!-- Anonymous Donation Option -->
                                        <div class="mt-4 d-flex align-items-center">
                                            <label class="form__ul-label form__ul-label--pointer ps-0">
                                                <span class="form__ul-div d-block">
                                                    <input type="checkbox"
                                                           name="anonymous_donation"
                                                           {% if form.anonymous_donation.value %}checked{% endif %}>
                                                    <span class="form__ul-label--checkmark form__ul-label--checkmark2"></span>
                                                    <span class="ps-2">Make this an anonymous donation.</span>
                                                </span>
                                            </label>
                                        </div>
                        
                                        <!-- Progress Bar -->
                                        <div class="mt-4">
                                            <div class="progress">
                                                <div class="progress-bar" 
                                                     role="progressbar" 
                                                     style="width: {{ case.progress_percentage }}%"
                                                     aria-valuenow="{{ case.progress_percentage }}%" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {{ case.progress_percentage|floatformat:2 }}%
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-2">
                                                <small>Raised: ₦{{ case.raised_amount|floatformat:2 }}</small>
                                                <small>Goal: ₦{{ case.goal_amount|floatformat:2 }}</small>
                                            </div>
                                        </div>
                        
                                        <!-- Submit Button -->
                                        <div class="mt-4">
                                            <button id="donateButton" class="global__btn" type="submit">
                                                <span class="button-text">Donate Now</span>
                                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                </div>
                <!-- Right Sider_Bar -->
                <div class="col-12 col-sm-8 col-lg-4 mt-5 mt-lg-0">
                    <div class="education__search">
                        <h4 class="education__txt">search</h4>
                        <form action="#" method="POST" class="d-flex position-relative mt-3">
                            <input class="education__inp form-control" type="text" placeholder="Enter your email">
                            <button class="global__btn education__inp-btn"><i
                                    class="fa-solid fa-magnifying-glass"></i></button>
                        </form>
                    </div>
                    <div class="education__cases">
                        <h4 class="education__txt">recent cases</h4>
                        <div class="">
                            <ul class="education__cases-list">
                                <li>
                                    <a class="education__cases-list--img" href="">
                                        <img class="" src="{% static '/img/recent-img-1.png' %}" alt="image">
                                    </a>
                                    <div class="">
                                        <a href="" class="education__cases-list--link">Education
                                            program in
                                            Uganda</a>
                                        <p class="education__cases-list--date">November 09, 2024</p>
                                    </div>
                                </li>
                                <li>
                                    <a class="education__cases-list--img" href="">
                                        <img class="" src="{% static '/img/recent-img-2.png' %}" alt="image">
                                    </a>
                                    <div class="">
                                        <a href="" class="education__cases-list--link">African water
                                            crisis :
                                            Children
                                            and women</a>
                                        <p class="education__cases-list--date">November 10, 2024</p>
                                    </div>
                                </li>
                                <li>
                                    <a class="education__cases-list--img" href="">
                                        <img class="" src="{% static '/img/recent-img-3.png' %}" alt="image">
                                    </a>
                                    <div class="">
                                        <a href="" class="education__cases-list--link">Be kind for the
                                            poor
                                            people and
                                            the kids.</a>
                                        <p class="education__cases-list--date">November 15, 2024</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="education__cases">
                        <h4 class="education__txt">Categories</h4>
                        <div class="">
                            <ul class="education__cases-list">
                                <li class="education__cases-list--m">
                                    <a href="#" class="education__cases-list--link education__cases-list--tag">healthy
                                        food</a>
                                </li>
                                <li class="education__cases-list--m">
                                    <a href="#" class="education__cases-list--link education__cases-list--tag">Free
                                        Education</a>
                                </li>
                                <li class="education__cases-list--m">
                                    <a href="#" class="education__cases-list--link education__cases-list--tag">Sickle cell awareness</a>
                                </li>
                                <li class="education__cases-list--m">
                                    <a href="#" class="education__cases-list--link education__cases-list--tag">Medical
                                        Emergencies</a>
                                </li>
                                <li class="education__cases-list--m">
                                    <a href="#" class="education__cases-list--link education__cases-list--tag">School supplies</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Form -->
            <div class="row">
                
            </div>
        </div>
    </div>
    <!-- Education END  -->


    <!--  Cases START  -->

    <div class="cases global__py pt-0">
        <div class="container p-sm-0">
            <div class="row">
                <div class="col-12 col-md-9 col-lg-6 text-center m-auto" data-aos="fade-down" data-aos-duration="1000">
                    <h3 class="global__text">Our cases</h3>
                    <h2 class="global__heading">
                        Popular causes what you should know
                    </h2>
                </div>
            </div>
            <div class="row">
                <div class="cases__slider3 position-relative">
                    <div class="cases__slider3-slider">
                        {% for case in cases %}
                            <div class="card cases__card">
                                <div class="cases__card-img">
                                    <a href="">
                                        {% if case.image %}
                                            <img class="img-fluid w-100" src="{{ case.image.url }}" alt="{{ case.title }}">
                                        {% else %}
                                            <img class="img-fluid w-100" src="{% static 'img/default.png' %}" alt="Default Image">
                                        {% endif %}
                                    </a>
                                    <h4 class="cases__card-tag">{{ case.category }}</h4>
                                </div>
                                <div class="card-body px-4">
                                    <div class="d-flex">
                                        <img class="cases__card-i" src="{% static 'img/location.svg' %}" alt="Location Icon">
                                        <span class="cases__card-location">{{ case.location }}</span>
                                    </div>
                                    <div class="">
                                        <a href="" class="cases__card-title">{{ case.title }}</a>
                                    </div>
                                    <div class="cases__card-range">
                                        <p class="global__desc m-0">Foundred: {{ case.progress_percentage|floatformat:2 }}%</p>
                                        <div class="progress cases__card-progress">
                                            <div class="progress-bar cases__card-progress--bar" role="progressbar"
                                                style="width: {{ case.progress_percentage }}%" aria-valuenow="{{ case.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="cases__card-range--bottom">
                                            <div class="d-flex align-items-center cases__card-range--bottom---m gap-2">
                                                <img class="cases__card-range--dollar" src="{% static 'img/box.svg' %}" alt="Raised Icon">
                                                <span class="cases__card-range--price">Raised: ₦{{ case.raised_amount|floatformat:2 }}</span>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <img class="cases__card-range--dollar" src="{% static 'img/dollar-s.svg' %}" alt="Goal Icon">
                                                <span class="cases__card-range--price">Goal: ₦{{ case.goal_amount|floatformat:2 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            
        </div>
    </div>

    <!--  Cases END  -->


    <!--  Join_US START -->

    <div class="join">
        <div class="container p-sm-0">
            <div class="row">
                <div class="card join__card">
                    <img src="{% static '/img/BG-Element.png' %}" class="img-fluid join__card-img" alt="image">
                    <div class="card-img-overlay join__card-layer">
                        <div class="col-11 col-md-7">
                            <h3 class="join__text global__text">Become a volenteer</h3>
                            <h2 class="join__heading global__heading">Join Your hand with us for a better life and
                                future
                            </h2>
                            <button class="join__card-layer--btn global__btn">Discover More</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('donationForm');
        const donateButton = document.getElementById('donateButton');
        const buttonText = donateButton.querySelector('.button-text');
        const spinner = donateButton.querySelector('.spinner-border');
        
        // Previous custom amount handling code remains...

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate required fields
            if (!validateForm()) {
                return;
            }

            // Show loading state
            donateButton.disabled = true;
            buttonText.textContent = 'Processing...';
            spinner.classList.remove('d-none');

            try {
                // Get form data
                const formData = new FormData(form);
                
                // Send the form data
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.redirect_url) {
                        // If payment gateway redirect is needed
                        window.location.href = data.redirect_url;
                    } else if (data.success) {
                        // Show success message
                        showMessage('Thank you for your donation!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showMessage(data.message || 'An error occurred. Please try again.', 'error');
                    }
                } else {
                    throw new Error(data.message || 'Server error');
                }
            } catch (error) {
                showMessage('An error occurred. Please try again.', 'error');
                console.error('Submission error:', error);
            } finally {
                // Reset button state
                donateButton.disabled = false;
                buttonText.textContent = 'Donate Now';
                spinner.classList.add('d-none');
            }
        });

        function validateForm() {
            let isValid = true;
            
            // Clear previous error messages
            clearErrors();

            // Validate amount
            const selectedAmount = form.querySelector('input[name="amount"]:checked');
            const customAmount = form.querySelector('input[name="custom_amount"]').value;
            
            if (!selectedAmount && !customAmount) {
                showError('Please select or enter a donation amount');
                isValid = false;
            }

            // Validate donation type
            const donationType = form.querySelector('input[name="donation_type"]:checked');
            if (!donationType) {
                showError('Please select a donation type');
                isValid = false;
            }

            // Validate required fields
            const requiredFields = ['first_name', 'last_name', 'email'];
            requiredFields.forEach(field => {
                const input = form.querySelector(`input[name="${field}"]`);
                if (!input.value.trim()) {
                    showError(`Please enter your ${field.replace('_', ' ')}`, field);
                    isValid = false;
                }
            });

            // Validate email format
            const email = form.querySelector('input[name="email"]');
            if (email.value && !isValidEmail(email.value)) {
                showError('Please enter a valid email address', 'email');
                isValid = false;
            }

            return isValid;
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showError(message, fieldName = null) {
            if (fieldName) {
                const field = form.querySelector(`[name="${fieldName}"]`);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback d-block';
                errorDiv.textContent = message;
                field.classList.add('is-invalid');
                field.parentNode.appendChild(errorDiv);
            } else {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.textContent = message;
                form.insertBefore(alertDiv, form.firstChild);
            }
        }

        function clearErrors() {
            // Remove general error messages
            form.querySelectorAll('.alert').forEach(alert => alert.remove());
            
            // Remove field-specific error messages
            form.querySelectorAll('.invalid-feedback').forEach(feedback => feedback.remove());
            form.querySelectorAll('.is-invalid').forEach(field => field.classList.remove('is-invalid'));
        }

        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} mt-3`;
            alertDiv.textContent = message;
            form.insertBefore(alertDiv, form.firstChild);
            
            // Scroll to message
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
</script>

    <!--  Join_US END -->

    {% endblock content %}